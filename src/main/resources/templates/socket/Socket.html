<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Hello WS</title>
  <link href="/webjars/bootstrap/5.1.3/css/bootstrap.min.css" rel="stylesheet">
  <script src="/webjars/jquery/3.3.1-1/jquery.min.js"></script>
  <script src="/webjars/sockjs-client/1.5.1/sockjs.js"></script>
  <script src="/webjars/stomp-websocket/2.3.4/stomp.min.js"></script>
<!--  <script src="/scripts.js"></script>-->
</head>
<body>
<div class="container" style="margin-top: 50px">
  <div class="row">
    <div class="col-md-12">
      <form class="form-inline">
        <div class="form-group">
          <label for="message">Message</label>
          <input type="text" id="message" class="form-control" placeholder="Enter your message here...">
        </div>
        <button id="send" class="btn btn-default" type="button">Send</button>
      </form>
    </div>
  </div>
  <div class="row" style="margin-top: 10px">
    <div class="col-md-12">
      <form class="form-inline">
        <div class="form-group">
          <label for="private-message">Private Message</label>
          <input type="text" id="private-message" class="form-control" placeholder="Enter your message here...">
        </div>
        <button id="send-private" class="btn btn-default" type="button">Send Private Message</button>
      </form>
    </div>
  </div>
  <div class="row">
    <div class="col-md-12">
      <table id="message-history" class="table table-striped">
        <thead>
        <tr>
          <th>Messages
            <span
                id="notifications"
                style="
                                    color: white;
                                    background-color: red;
                                    padding-left: 15px;
                                    padding-right: 15px;">
                            </span>
          </th>
        </tr>
        </thead>
        <tbody id="messages">
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
  var stompClient = null;
  var notificationCount = 0;

  $(document).ready(function() {
    console.log("Index page is ready");
    connect();

    $("#send").click(function() {
      sendMessage();
    });

    $("#send-private").click(function() {
      sendPrivateMessage();
    });

    $("#notifications").click(function() {
      resetNotificationCount();
    });
  });

  function connect() {
    var socket = new SockJS('/gs-guide-websocket');
    stompClient = Stomp.over(socket);
    stompClient.connect({}, function (frame) {
      var url = stompClient.ws._transport.url;
      console.log(`url:    ${url}`)
      // url = url.replace(
      //     "ws://localhost:8080/spring-security-mvc-socket/secured/room/",  "");
      // url = url.replace("/websocket", "");
      // url = url.replace(/^[0-9]+\//, "");
      // console.log("Your current session is: " + url);
      // sessionId = url;
      console.log('Connected: ' + frame);
      updateNotificationDisplay();
      stompClient.subscribe('/topic/messages', function (message) {
        showMessage(JSON.parse(message.body).content);
      });

      stompClient.subscribe('/user/topic/private-messages', function (message) {
        showMessage(JSON.parse(message.body).content);
      });

      stompClient.subscribe('/topic/global-notifications', function (message) {
        notificationCount = notificationCount + 1;
        updateNotificationDisplay();
      });

      stompClient.subscribe('/user/topic/private-notifications', function (message) {
        notificationCount = notificationCount + 1;
        updateNotificationDisplay();
      });
    });
  }

  function showMessage(message) {
    $("#messages").append("<tr><td>" + message + "</td></tr>");
  }

  function sendMessage() {
    console.log("sending message");
    stompClient.send("/ws/message", {}, JSON.stringify({'messageContent': $("#message").val()}));
  }

  function sendPrivateMessage() {
    console.log("sending private message");
    stompClient.send("/ws/private-message", {}, JSON.stringify({'messageContent': $("#private-message").val()}));
  }

  function updateNotificationDisplay() {
    if (notificationCount === 0) {
      $('#notifications').hide();
    } else {
      $('#notifications').show();
      $('#notifications').text(notificationCount);
    }
  }

  function resetNotificationCount() {
    notificationCount = 0;
    updateNotificationDisplay();
  }
</script>
</body>
</html>